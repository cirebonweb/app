/**
 * cirebonweb_fetch.min.js
 * * Helper AJAX berbasis jQuery untuk aplikasi CodeIgniter 4.
 * Menyediakan konfigurasi default yang konsisten, penanganan error global, 
 * dan shorthand method (get, post).
 * * Penggunaan:
 * - Pastikan file ini dimuat setelah jQuery.
 * - Untuk request kustom: $.crb_fetch(url, data, method, options)
 * - Untuk POST: $.crb_post(url, data, options)
 * - Untuk GET: $.crb_get(url, data, options)
 * * * Tambahan Opsi Kustom (di dalam objek 'options'):
 * - before_call: function() {} // Dijalankan sebelum request dimulai (untuk manipulasi UI lokal)
 * - after_call: function() {}  // Dijalankan setelah request selesai (untuk membersihkan UI lokal)
 */
(function ($) {
    // Definisi variabel global untuk status loading
    let loading_requests = 0;

    /**
     * Fungsi untuk menampilkan status loading global (misalnya, spinner)
     */
    function showLoadingIndicator() {
        if (loading_requests === 0) {
            // Logika menampilkan loading spinner/overlay di sini
            console.log("-> Tampilkan Loading: Mulai proses AJAX.");
            // Contoh implementasi: $('#global-spinner').show();
        }
        loading_requests++;
    }

    /**
     * Fungsi untuk menyembunyikan status loading global
     */
    function hideLoadingIndicator() {
        loading_requests--;
        if (loading_requests <= 0) {
            loading_requests = 0; // Pastikan tidak negatif
            // Logika menyembunyikan loading spinner/overlay di sini
            console.log("<- Sembunyikan Loading: Semua request AJAX selesai.");
            // Contoh implementasi: $('#global-spinner').hide();
        }
    }

    /**
     * Fungsi utama untuk mengirim request AJAX.
     * @param {string} url - URL tujuan di Controller CI4.
     * @param {Object} data - Data yang akan dikirim.
     * @param {string} method - Metode HTTP (GET, POST, PUT, DELETE). Default: 'POST'.
     * @param {Object} options - Opsi tambahan untuk $.ajax().
     * @returns {jqXHR} - Objek jqXHR (Promise) untuk chaining (.done(), .fail(), .always()).
     */
    $.crb_fetch = function (url, data = {}, method = 'POST', options = {}) {

        // --- 1. Jalankan Callback Kustom BEFORE ---
        // Ini memungkinkan manipulasi DOM lokal (misalnya, tombol dinonaktifkan)
        if (options.before_call && typeof options.before_call === 'function') {
            options.before_call();
        }

        // Konfigurasi default untuk request data (bukan file upload)
        const default_options = {
            url: url,
            method: method.toUpperCase(),
            data: data,
            dataType: 'json', // Default: Mengharap respons JSON
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8', // Data standar
            processData: true,
            cache: false, // Penting untuk GET agar tidak di-cache browser
            // Tambahkan timeout atau headers default lainnya di sini jika diperlukan
        };

        // Gabungkan opsi default dengan opsi kustom
        // Gunakan deep extend (true) untuk menggabungkan options dengan benar
        const final_options = $.extend(true, {}, default_options, options);

        // Tampilkan indikator loading global sebelum request
        showLoadingIndicator();

        // Kirim request AJAX
        const jqXHR = $.ajax(final_options);

        jqXHR.done(function (response) {
            if (response || response.success) {
                // Swal.fire('Sukses', response.messages, 'success');
            } else {
                if (response.messages && typeof response.messages === 'object') {
                    Swal.fire('Peringatan', response.messages, 'warning');
                } else {
                    Swal.fire('Gagal', response.messages || 'Pesan kesalahan tidak dikenali.', 'error');
                }
            }
        })

        // Penanganan error global (Error HTTP, Timeout, Abort)
        jqXHR.fail(function (jqXHR, textStatus, errorThrown) {
            let error_message = "Terjadi Kesalahan! ";

            if (jqXHR.status === 0) {
                // Network error, atau request di-abort
                error_message += "Gagal terhubung ke server atau request dibatalkan.";
            } else if (jqXHR.status >= 400 && jqXHR.status < 500) {
                // Error klien (4xx)
                error_message += `URL tidak ditemukan atau akses ditolak. Status: ${jqXHR.status}.`;
            } else if (jqXHR.status >= 500) {
                // Error server (5xx)
                error_message += `Kesalahan internal server. Status: ${jqXHR.status}.`;
            } else if (textStatus === 'parsererror') {
                error_message += "Respons server tidak valid (bukan JSON). Cek format data di Controller.";
            } else if (textStatus === 'timeout') {
                error_message += "Waktu tunggu (timeout) request habis.";
            } else {
                error_message += `Kesalahan tidak terduga: ${errorThrown}.`;
            }

            console.error(error_message, jqXHR);
            Swal.fire('Error', error_message, 'error');
        });

        // Penanganan Complete (selalu dipanggil setelah sukses/gagal)
        jqXHR.always(function () {
            // --- 2. Jalankan Callback Kustom AFTER ---
            // Ini memungkinkan pembersihan DOM lokal (misalnya, tombol diaktifkan kembali)
            if (options.after_call && typeof options.after_call === 'function') {
                options.after_call();
            }

            // Sembunyikan indikator loading global
            hideLoadingIndicator();
            Beranda.refreshCsrf();
        });

        // Kembalikan Promise (jqXHR) untuk penanganan spesifik
        return jqXHR;
    };

    /**
     * Shorthand untuk request POST.
     * @param {string} url - URL tujuan.
     * @param {Object} data - Data yang akan dikirim.
     * @param {Object} options - Opsi tambahan.
     * @returns {jqXHR}
     */
    $.crb_post = function (url, data = {}, options = {}) {
        return $.crb_fetch(url, data, 'POST', options);
    };

    /**
     * Shorthand untuk request GET.
     * @param {string} url - URL tujuan.
     * @param {Object} data - Data parameter URL.
     * @param {Object} options - Opsi tambahan.
     * @returns {jqXHR}
     */
    $.crb_get = function (url, data = {}, options = {}) {
        return $.crb_fetch(url, data, 'GET', options);
    };

})(jQuery);

// (function ($) {
//     // Definisi variabel global untuk status loading
//     let loading_requests = 0;

//     /**
//      * Fungsi untuk menampilkan status loading global (misalnya, spinner)
//      */
//     function showLoadingIndicator() {
//         if (loading_requests === 0) {
//             // Logika menampilkan loading spinner/overlay di sini
//             console.log("-> Tampilkan Loading: Mulai proses AJAX.");
//             // Contoh implementasi: $('#global-spinner').show();
//         }
//         loading_requests++;
//     }

//     /**
//      * Fungsi untuk menyembunyikan status loading global
//      */
//     function hideLoadingIndicator() {
//         loading_requests--;
//         if (loading_requests <= 0) {
//             loading_requests = 0; // Pastikan tidak negatif
//             // Logika menyembunyikan loading spinner/overlay di sini
//             console.log("<- Sembunyikan Loading: Semua request AJAX selesai.");
//             // Contoh implementasi: $('#global-spinner').hide();
//         }
//     }

//     /**
//      * Fungsi utama untuk mengirim request AJAX.
//      * @param {string} url - URL tujuan di Controller CI4.
//      * @param {Object} data - Data yang akan dikirim.
//      * @param {string} method - Metode HTTP (GET, POST, PUT, DELETE). Default: 'POST'.
//      * @param {Object} options - Opsi tambahan untuk $.ajax().
//      * @returns {jqXHR} - Objek jqXHR (Promise) untuk chaining (.done(), .fail(), .always()).
//      */
//     $.crb_fetch = function (url, data = {}, method = 'POST', options = {}) {

//         // --- 1. Jalankan Callback Kustom BEFORE ---
//         // Ini memungkinkan manipulasi DOM lokal (misalnya, tombol dinonaktifkan)
//         if (options.before_call && typeof options.before_call === 'function') {
//             options.before_call();
//         }

//         // Konfigurasi default untuk request data (bukan file upload)
//         const default_options = {
//             url: url,
//             method: method.toUpperCase(),
//             data: data,
//             dataType: 'json', // Default: Mengharap respons JSON
//             contentType: 'application/x-www-form-urlencoded; charset=UTF-8', // Data standar
//             processData: true,
//             cache: false, // Penting untuk GET agar tidak di-cache browser
//             // Tambahkan timeout atau headers default lainnya di sini jika diperlukan
//         };

//         // Gabungkan opsi default dengan opsi kustom
//         // Gunakan deep extend (true) untuk menggabungkan options dengan benar
//         const final_options = $.extend(true, {}, default_options, options);

//         // Tampilkan indikator loading global sebelum request
//         showLoadingIndicator();

//         // Kirim request AJAX
//         const jqXHR = $.ajax(final_options);

//         // Penanganan error global (Error HTTP, Timeout, Abort)
//         jqXHR.fail(function (jqXHR, textStatus, errorThrown) {
//             let error_message = "Terjadi Kesalahan! ";

//             if (jqXHR.status === 0) {
//                 // Network error, atau request di-abort
//                 error_message += "Gagal terhubung ke server atau request dibatalkan.";
//             } else if (jqXHR.status >= 400 && jqXHR.status < 500) {
//                 // Error klien (4xx)
//                 error_message += `URL tidak ditemukan atau akses ditolak. Status: ${jqXHR.status}.`;
//             } else if (jqXHR.status >= 500) {
//                 // Error server (5xx)
//                 error_message += `Kesalahan internal server. Status: ${jqXHR.status}.`;
//             } else if (textStatus === 'parsererror') {
//                 error_message += "Respons server tidak valid (bukan JSON). Cek format data di Controller.";
//             } else if (textStatus === 'timeout') {
//                 error_message += "Waktu tunggu (timeout) request habis.";
//             } else {
//                 error_message += `Kesalahan tidak terduga: ${errorThrown}.`;
//             }

//             console.error(error_message, jqXHR);
//             Swal.fire('Error', error_message, 'error');
//             // Anda dapat mengganti console.error dengan notifikasi UI (Toast/Modal)
//             // Misalnya: showToast('error', error_message);
//         });

//         // Penanganan Complete (selalu dipanggil setelah sukses/gagal)
//         jqXHR.always(function () {
//             // --- 2. Jalankan Callback Kustom AFTER ---
//             // Ini memungkinkan pembersihan DOM lokal (misalnya, tombol diaktifkan kembali)
//             if (options.after_call && typeof options.after_call === 'function') {
//                 options.after_call();
//             }

//             // Sembunyikan indikator loading global
//             hideLoadingIndicator();
//             Beranda.refreshCsrf();
//         });

//         // Kembalikan Promise (jqXHR) untuk penanganan spesifik
//         return jqXHR;
//     };

//     /**
//      * Shorthand untuk request POST.
//      * @param {string} url - URL tujuan.
//      * @param {Object} data - Data yang akan dikirim.
//      * @param {Object} options - Opsi tambahan.
//      * @returns {jqXHR}
//      */
//     $.crb_post = function (url, data = {}, options = {}) {
//         return $.crb_fetch(url, data, 'POST', options);
//     };

//     /**
//      * Shorthand untuk request GET.
//      * @param {string} url - URL tujuan.
//      * @param {Object} data - Data parameter URL.
//      * @param {Object} options - Opsi tambahan.
//      * @returns {jqXHR}
//      */
//     $.crb_get = function (url, data = {}, options = {}) {
//         return $.crb_fetch(url, data, 'GET', options);
//     };

// })(jQuery);


// **********************************************
// CONTOH PENGGUNAAN
// **********************************************
// Anda bisa menggunakan $.crb_post atau $.crb_fetch
// $.crb_post(url_simpan, data_form, {
//     // ... opsi before_call / after_call
// })
//     .done(function (response) {
//         // Variabel 'response' kini adalah objek JavaScript: { success: ..., messages: ... }

//         if (response.success) {
//             // --- Operasi Sukses ---
//             // response.messages akan berisi pesan sukses
//             alert(response.messages);
//             // Lakukan aksi lanjutan (misalnya, reload data)

//             // Jika respons Anda juga mengembalikan data tambahan (misalnya, ID baru):
//             // console.log(response.data.new_id); 

//         } else {
//             // --- Operasi Gagal (Validasi/Logika) ---
//             // response.messages akan berisi pesan error dari controller
//             alert("Gagal: " + response.messages);
//             // Tampilkan notifikasi error
//         }
//     });

// // Contoh Paling Sederhana (Menggunakan POST dengan data kosong)
// $.crb_post("<?= base_url('api/logout') ?>")
//     .done(function (response) {
//         // Lanjutkan ke halaman login
//     });

// // Contoh Paling Sederhana (Menggunakan GET tanpa data parameter)
// $.crb_get("<?= base_url('api/daftar/kategori') ?>")
//     .done(function (response) {
//         // ... proses data kategori
//     });

// $('.btn-delete').on('click', function () {
//     const $btn = $(this);
//     const item_id = $btn.data('id');

//     if (!confirm('Apakah Anda yakin ingin menghapus item ini?')) {
//         return; // Batalkan jika user menekan 'Cancel'
//     }

//     // Panggil helper
//     $.crb_post("<?= base_url('api/item/delete') ?>", { id: item_id }, {
//         before_call: function () {
//             // Menonaktifkan hanya tombol yang sedang diklik
//             $btn.attr('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading');
//         },
//         after_call: function () {
//             // Mengaktifkan kembali tombol setelah selesai (bisa sukses/gagal)
//             $btn.attr('disabled', false).html('<i class="fas fa-trash"></i> Hapus');
//         }
//     })
//         .done(function (response) {
//             if (response.success) {
//                 alert(response.messages);
//                 // Hapus baris item dari DOM jika sukses
//                 $btn.closest('tr').remove();
//             } else {
//                 alert("Gagal menghapus: " + response.messages);
//             }
//         });
// });


// const $form = $('#form-data-pengguna');
// const $btnSubmit = $('#btn-simpan');

// // Fungsi Placeholder untuk manipulasi validasi
// function clearFormValidation() {
//     // 1. Hapus semua kelas error Bootstrap
//     $form.find('.is-invalid').removeClass('is-invalid');
//     // 2. Hapus semua pesan error
//     $form.find('.invalid-feedback').text('');
// }

// function displayFormErrors(errors) {
//     // Fungsi ini akan beriterasi melalui objek errors dari CI4
//     // dan menampilkan pesan di sebelah field yang sesuai
//     for (const field in errors) {
//         // Asumsi field memiliki ID yang sama dengan namanya, 
//         // dan di bawahnya ada elemen feedback
//         $form.find(`[name="${field}"]`).addClass('is-invalid');
//         $form.find(`[name="${field}"]`).next('.invalid-feedback').text(errors[field]);
//     }
// }

// $btnSubmit.on('click', function () {
//     $.crb_post("<?= base_url('api/user/save') ?>", $form.serialize(), {

//         // **********************************************
//         // 1. BEFORE_CALL: Reset Validation dan Disable Tombol
//         // **********************************************
//         before_call: function () {
//             // Tugas 1: Pastikan error lama hilang sebelum mengirim data baru
//             clearFormValidation();

//             // Tugas 2: Lock UI lokal
//             $btnSubmit.attr('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Menyimpan...');
//         },

//         // **********************************************
//         // 2. AFTER_CALL: Restore Tombol (Selalu Jalan)
//         // **********************************************
//         after_call: function () {
//             // Tugas 3: Unlock UI lokal, terlepas dari sukses/gagal
//             $btnSubmit.attr('disabled', false).html('Simpan');
//         }
//     })
//         .done(function (response) {
//             // **********************************************
//             // 3. DONE: Tampilkan Hasil (Validasi/Sukses)
//             // **********************************************
//             if (response.success) {
//                 // Sukses (Simpan)
//                 alert("Sukses: " + response.messages);
//                 $('#myModal').modal('hide'); // Tutup modal jika ada
//             } else {
//                 // Gagal (Biasanya Validasi atau Error Logika)
//                 alert("Gagal: " + response.messages);

//                 if (response.errors) {
//                     // Tampilkan pesan error validasi baru dari CI4
//                     displayFormErrors(response.errors);
//                 }
//             }
//         });
// });
