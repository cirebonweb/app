$(document).ready(function () {
    // Inisialisasi BS Stepper
    var stepper = new Stepper(document.querySelector('#stepper'));

    // Inisialisasi JQuery Validate
    const $serverForm = $('#serverForm');
    const $btnServerTes = $('#btnServerTes');
    const $testStatus = $('#testStatus');

    // Inisialisasi Datepicker
    $('.date').datepicker({
        dateFormat: 'yy-mm-dd'
    });

    // --- FUNGSI VALIDASI & TOMBOL NEXT ---

    // Fungsi untuk menampilkan status tes
    function showTestStatus(message, isSuccess = true) {
        $testStatus.removeClass('text-success text-danger').text(message);
        if (isSuccess) {
            $testStatus.addClass('text-success');
        } else {
            $testStatus.addClass('text-danger');
        }
    }

    // Inisialisasi Validasi JQuery
    $serverForm.validate({
        // Konfigurasi Validasi Custom
        ignore: [],
        errorElement: 'span',
        errorClass: 'invalid-feedback',
        highlight: function (element) {
            $(element).addClass('is-invalid').removeClass('is-valid');
        },
        unhighlight: function (element) {
            $(element).removeClass('is-invalid').addClass('is-valid');
        },
        errorPlacement: function (error, element) {
            const $parent = element.closest('.input-group, .form-group, .px-3');
            if ($parent.length) {
                // Cari div paling dekat untuk menempatkan pesan error
                error.appendTo($parent);
            } else if (element.is('.select') || element.hasClass('select2') || element.hasClass('selectpicker')) {
                error.insertAfter(element.next());
            } else {
                error.insertAfter(element);
            }
        },

        // Aturan Validasi Baru
        rules: {
            server_nama: { required: true, minlength: 3, maxlength: 50 },
            server_lokasi: { required: false, maxlength: 100 },
            server_ip: { required: false, ipv4: true },
            server_url: { required: false, url: true, maxlength: 255 },
            sewa_biaya: { required: false, number: true, min: 0 },
            sewa_awal: { required: false, dateISO: true },
            sewa_akhir: { required: false, dateISO: true },
            akun_limit: { required: false, digits: true, min: 0 },
            akun_aktif: { required: false, digits: true, min: 0 },
            aktivasi: { required: true, digits: true, range: [0, 1] },
            con_host: { required: true, maxlength: 100 },
            con_user: { required: true, maxlength: 50 },
            con_token: { required: true, minlength: 20, maxlength: 255 },
            con_port: { required: true, digits: true, range: [1, 65535] },
            server_os: { required: false, maxlength: 40 },
            cpanel_versi: { required: false, maxlength: 15 },
            ns1: { required: false, maxlength: 100 },
            ns2: { required: false, maxlength: 100 },
            ns3: { required: false, maxlength: 100 },
            ns4: { required: false, maxlength: 100 },
            ip1: { required: false, ipv4: true },
            ip2: { required: false, ipv4: true },
            ip3: { required: false, ipv4: true },
            ip4: { required: false, ipv4: true }
        },
        messages: {
            // Menggunakan default pesan dari plugin jquery-validate_id.min.js
        }
    });

    // Menangani tombol 'Lanjut' untuk setiap langkah
    $('.btn-next-form').on('click', function () {
        const currentStepId = $(this).closest('.content').attr('id');
        let isValid = true;

        // Cek validitas semua field dalam langkah saat ini
        $(this).closest('.content').find(':input').each(function () {
            if (!$serverForm.validate().element($(this))) {
                isValid = false;
            }
        });

        if (isValid) {
            stepper.next();
        } else {
            // Jika tidak valid, pemicu pesan error agar muncul
            // (Sudah ditangani oleh $serverForm.validate().element() di atas)
        }
    });

    // Menangani tombol 'Kembali'
    $('.btn-prev-form').on('click', function () {
        stepper.previous();
    });

    // --- FUNGSI TES KONEKSI API ---

    $btnServerTes.on('click', function () {
        // Hanya validasi field yang diperlukan di Step 2 (dan con_host di Step 1)
        const requiredFields = ['con_host', 'con_user', 'con_token', 'con_port'];
        let isValid = true;

        requiredFields.forEach(field => {
            if (!$(`#${field}`).valid()) {
                isValid = false;
            }
        });

        if (!isValid) {
            showTestStatus('Lengkapi Hostname, User, Token, dan Port sebelum menguji koneksi.', false);
            return;
        }

        const data = {
            con_host: $('#con_host').val(),
            con_user: $('#con_user').val(),
            con_token: $('#con_token').val(),
            con_port: $('#con_port').val(),
        };

        $btnServerTes.attr('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Menguji...');
        showTestStatus('');

        $.ajax({
            // Menggunakan URL relatif
            url: 'server/tesapi',
            method: 'POST',
            data: data,
            dataType: 'json',
            success: function (response) {
                if (response.success) {
                    showTestStatus(response.message, true);

                    // Autofill data yang dikembalikan API (Step 1 & Step 2)
                    $('#server_ip').val(response.data.server_ip || ''); // Step 1
                    $('#akun_aktif').val(response.data.akun_aktif || '0'); // Step 1
                    $('#cpanel_versi').val(response.data.cpanel_versi || ''); // Step 2

                } else {
                    showTestStatus(response.message, false);
                    // Kosongkan field autofill jika gagal
                    $('#server_ip').val('');
                    $('#akun_aktif').val('0');
                    $('#cpanel_versi').val('');
                }
            },
            error: function () {
                showTestStatus('Error koneksi ke server aplikasi.', false);
                console.error("Error Test Connection: Koneksi gagal atau server tidak merespons.");
                $('#server_ip').val('');
                $('#akun_aktif').val('0');
                $('#cpanel_versi').val('');
            },
            complete: function () {
                $btnServerTes.attr('disabled', false).html('Tes Koneksi');
            }
        });
    });

    // --- FUNGSI SIMPAN (SUBMIT FORM) ---

    $serverForm.on('submit', function (e) {
        e.preventDefault();

        if (!$serverForm.valid()) {
            showTestStatus('Lengkapi semua data yang wajib diisi.', false);
            // Kembali ke step 1 jika ada validasi error di sana
            if (!$('#server_nama').valid() || !$('#server_ip').valid() || !$('#con_host').valid()) {
                stepper.to(1);
            } else if (!$('#con_user').valid() || !$('#con_token').valid() || !$('#con_port').valid()) {
                // Kembali ke step 2 jika error di koneksi
                stepper.to(2);
            } else {
                stepper.to(3);
            }
            return;
        }

        // Ambil ID Server
        const serverId = $('#server_id').val();

        // Tentukan URL POST: Simpan atau Update
        let postUrl = '';
        if (serverId && serverId !== '0' && serverId !== '') {
            postUrl = 'server/update'; // Mode Edit/Update
        } else {
            postUrl = 'server/simpan'; // Mode Simpan/Insert Baru
        }

        // Ambil semua data form
        const data = $serverForm.serializeArray();

        const $btnSubmit = $serverForm.find('button[type="submit"]');
        $btnSubmit.attr('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Menyimpan...');
        showTestStatus('');

        $.ajax({
            // Menggunakan URL dinamis
            url: postUrl,
            method: 'POST',
            data: data,
            dataType: 'json',
            success: function (response) {
                if (response.success) {
                    // Tampilkan SweetAlert sukses (Ganti window.location.href)
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil!',
                        text: response.message || 'Konfigurasi server berhasil disimpan.',
                        showConfirmButton: false,
                        timer: 2000
                    }).then(() => {
                        // Jika berhasil, redirect ke halaman daftar
                        if (response.id) {
                            // Asumsi bahwa ID yang dikembalikan (response.id) adalah ID server yang baru/diperbarui
                        }
                    });
                } else {
                    // Tampilkan SweetAlert error
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal Menyimpan!',
                        text: 'Terjadi kesalahan: ' + (response.message || 'Silakan cek kembali data Anda.'),
                    });
                }
            },
            error: function () {
                // Tampilkan SweetAlert error koneksi
                Swal.fire({
                    icon: 'error',
                    title: 'Error Koneksi!',
                    text: 'Terjadi kesalahan saat koneksi ke server aplikasi.',
                });
                console.error("Error Save Config: Koneksi gagal atau server tidak merespons.");
            },
            complete: function () {
                $btnSubmit.attr('disabled', false).html('Simpan');
            }
        });
    });

    // Fungsionalitas tambahan: Autofill data saat load
    // Jika ada ID server, panggil API untuk mengisi form (asumsi Anda memiliki route 'admin.api.server.load/{id}')
    const serverId = $('#server_id').val();
    if (serverId) {
        // Implementasi Load data server di sini jika diperlukan
    }
});
