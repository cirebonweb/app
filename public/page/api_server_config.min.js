stepper = new Stepper(document.querySelector('#stepper'));

const $formServer = $('#formServer'),
    formCek = $.crb_validasi.cekForm($formServer),
    $btnTesKoneksi = $('#btnTesKoneksi'),
    $spanTesKoneksi = $('#spanTesKoneksi'),
    $btnSubmit = $formServer.find('button[type="submit"]');;

// Fungsi Placeholder untuk membersihkan validasi
function clearFormValidation(target) {
    const $target = $(target);
    const form = $target.find('form')[0];
    if (form) form.reset();

    $target.find('.is-invalid, .is-valid').removeClass('is-invalid is-valid');
    $target.find('.invalid-feedback, .valid-feedback').remove();
};

$(function () {
    // Tambahkan custom rule modular
    $.validator.addMethod('ipv4', function (value, element) {
        return this.optional(element) ||
            /^(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(\d{1,3}\.){2}\d{1,3}$/.test(value);
    }, "Masukkan IP valid.");

    // Validasi form
    $formServer.validate($.extend(true, {}, $.crb_validasi.Element, {
        rules: {
            server_nama: { required: true, minlength: 3, maxlength: 50 },
            server_lokasi: { required: false, maxlength: 100 },
            server_ip: { required: false, ipv4: true },
            server_url: { required: false, url: true, maxlength: 255 },
            sewa_biaya: { required: false, number: true, min: 0 },
            sewa_awal: { required: false, dateISO: true },
            sewa_akhir: { required: false, dateISO: true },
            akun_limit: { required: false, digits: true, min: 0 },
            akun_aktif: { required: false, digits: true, min: 0 },
            aktivasi: { required: true, digits: true, range: [0, 1] },
            con_host: { required: true, maxlength: 100 },
            con_user: { required: true, maxlength: 50 },
            con_token: { required: true, minlength: 20, maxlength: 255 },
            con_port: { required: true, digits: true, range: [1, 65535] },
            server_os: { required: false, maxlength: 40 },
            cpanel_versi: { required: false, maxlength: 15 },
            ns1: { required: false, maxlength: 100 },
            ns2: { required: false, maxlength: 100 },
            ns3: { required: false, maxlength: 100 },
            ns4: { required: false, maxlength: 100 },
            ip1: { required: false, ipv4: true },
            ip2: { required: false, ipv4: true },
            ip3: { required: false, ipv4: true },
            ip4: { required: false, ipv4: true }
        }
    }));

    // Menangani tombol 'Lanjut' untuk setiap langkah
    $('.btn-next-form').on('click', function () {
        $(this).closest('.content').attr('id');
        let isValid = true;

        // Cek validitas semua field dalam langkah saat ini
        $(this).closest('.content').find(':input').each(function () {
            if (!$formServer.validate().element($(this))) {
                isValid = false;
            }
        });

        if (isValid) { stepper.next() }
    });

    // Menangani tombol 'Kembali'
    $('.btn-prev-form').on('click', function () {
        stepper.previous();
    });

    // Tes Koneksi
    $btnTesKoneksi.on('click', function (e) {
        e.preventDefault();

        const validTesKoneksi = ['con_host', 'con_user', 'con_token', 'con_port'];
        let isValid = true;

        validTesKoneksi.forEach(field => {
            if (!$(`#${field}`).valid()) { isValid = false; }
        });

        if (!isValid) { return }

        const dataTesKoneksi = {
            con_host: $('#con_host').val(),
            con_user: $('#con_user').val(),
            con_token: $('#con_token').val(),
            con_port: $('#con_port').val(),
        };

        $.crb_post('server/tesapi', dataTesKoneksi, {
            before_call: function () {
                $spanTesKoneksi.html('');
                $btnTesKoneksi.attr('disabled', true).html('<span class="spinner-border spinner-border-sm mr-1" role="status" aria-hidden="true"></span> Loading...');
            },
            after_call: function () {
                $btnTesKoneksi.attr('disabled', false).html('Tes Koneksi');
            }
        })
            .done(function (response) {
                if (response.success) {
                    $('#server_ip').val(response.data.server_ip || '');
                    $('#akun_aktif').val(response.data.akun_aktif || '0');
                    $('#cpanel_versi').val(response.data.cpanel_versi || '');
                    $spanTesKoneksi.html('<span class="text-success">✅ Koneksi Berhasil!</span>');
                } else {
                    $spanTesKoneksi.html('<span class="text-danger">❌ Koneksi Gagal!</span>');
                }
            })
            .fail(function () {
                $spanTesKoneksi.html('<span class="text-danger">❌ Koneksi Error!</span>');
            });
    });

    // Submit (Insert/Update)
    $formServer.on('submit', function (e) {
        e.preventDefault();
        if (!$formServer.valid()) { return }
        if (!formCek.isChanged()) return false;

        // Ambil ID Server
        const serverId = $('#server_id').val();

        // Tentukan URL POST: Simpan atau Update
        let postUrl = '';
        let textSubmit = 'Submit';
        if (serverId === '0' && serverId === '') {
            postUrl = 'server/simpan';
            textSubmit = 'Simpan';
        } else {
            postUrl = 'server/update';
            textSubmit = 'Update';
        }

        $.crb_post('server/simpan', $formServer.serializeArray(), {
            before_call: function () {
                $btnSubmit.attr('disabled', true).html('<span class="spinner-border spinner-border-sm mr-1" role="status" aria-hidden="true"></span> Loading...');
            },
            after_call: function () { $btnSubmit.attr('disabled', false).html(textSubmit) }
        })
            .done(function (response) {
                if (response.success) {
                    Swal.fire('Sukses', response.messages, 'success').then(() => {
                        location.reload()
                    })
                }
            });
        // .always(() => { formCek.resetInitial() });
    });

    // --- Inisialisasi Datepicker ---
    $('.date').datepicker({
        dateFormat: 'yy-mm-dd'
    });

    // Logika format angka untuk sewa_biaya
    $('.nominal').on('blur', function () {
        let raw = $(this).val().replace(/\./g, '').replace(',', '.'); // hapus ribuan, ubah koma ke titik
        let num = parseFloat(raw);

        if (!isNaN(num)) {
            // tampilkan versi format
            $(this).val(num.toLocaleString('id-ID', { minimumFractionDigits: 2 }));
            // simpan versi asli ke hidden
            $('#sewa_biaya').val(num.toFixed(2));
        } else {
            $(this).val('');
            $('#sewa_biaya').val('');
        }
    });


    // --- Event Listener untuk Case Input (Capital) ---
    $('input.capital').on('input', function () {
        const input = $(this).val();
        if (input.length > 0) {
            const capitalized = input.charAt(0).toUpperCase() + input.slice(1);
            $(this).val(capitalized);
        }
    });
});
