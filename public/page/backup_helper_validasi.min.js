
if (typeof $.validator !== 'undefined') {
    // Perhatian: Karena fungsi IsEmail() tidak didefinisikan di sini, 
    // kami menggunakan ekspresi reguler email standar sebagai gantinya.
    $.validator.addMethod("customEmail", function (value, element) {
        return this.optional(element) || /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/.test(value);
    }, "Email tidak valid (contoh: user@example.com)");

    $.validator.addMethod('ipv4', function (value, element) {
        return this.optional(element) ||
            /^(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(\d{1,3}\.){2}\d{1,3}$/.test(value);
    }, "Masukkan IP valid.");
}

const CrbwebValidasi = {
    /**
     * Reset validasi form: hapus class, feedback dan reset nilai input.
     *
     * @param {string|object} target Selector atau elemen jQuery yang mengandung form.
     */
    resetForm: function (target) {
        const $target = $(target);
        $target.find('form')[0].reset();
        $target.find('.is-invalid, .is-valid').removeClass('is-invalid is-valid');
        $target.find('.invalid-feedback, .valid-feedback').remove();
    },
};

(function ($) {
    /**
     * cirebonweb_validasi
     * Helper Utilitas Form untuk aplikasi CodeIgniter 4.
     * Menyediakan fungsi untuk membersihkan status validasi form 
     * yang dibuat menggunakan jQuery Validation Plugin dan Bootstrap.
     */
    $.crb_validasi = {
        /**
         * Helper untuk mengecek perubahan pada data form.
         * Menggunakan closure untuk menyimpan data awal form.
         *
         * @param {object} formSelector Elemen form jQuery atau selector string.
         * @returns {{isChanged: function, resetInitial: function}}
         */
        cekForm: function (formSelector) {
            let $form = $(formSelector);
            if ($form.attr('data-cek') !== 'true') {
                return { isChanged: () => true, resetInitial: () => { } };
            }

            let initialData = {};

            function setInitialData() {
                initialData = {};
                $form.find('input, select, textarea').each(function () {
                    let name = $(this).attr('name');
                    if (!name) return;
                    if ($(this).is(':checkbox, :radio')) {
                        initialData[name] = $(this).is(':checked');
                    } else {
                        initialData[name] = $(this).val();
                    }
                });
            }

            function checkChanged() {
                let changed = false;
                $form.find('input, select, textarea').each(function () {
                    let name = $(this).attr('name');
                    if (!name) return;

                    let currentVal = $(this).is(':checkbox, :radio') ? $(this).is(':checked') : $(this).val();
                    if (currentVal != initialData[name]) {
                        changed = true;
                        return false;
                    }
                });

                if (!changed) {
                    $form.find(':input').removeClass('is-invalid is-valid');
                    Swal.fire({
                        icon: 'info',
                        title: 'Informasi',
                        html: 'Data input tidak ada perubahan. <br> Proses simpan dibatalkan.',
                    });
                }
                return changed;
            }

            setInitialData();
            return { isChanged: checkChanged, resetInitial: setInitialData };
        },

        /**
         * Membersihkan semua indikator dan pesan validasi dari form target.
         * Ini ideal dipanggil di dalam before_call sebelum request AJAX dikirim.
         * * @param {string|HTMLElement|jQuery} target Selector atau elemen form yang akan dibersihkan.
         */
        Clear: function (target) {
            const $target = $(target);

            if ($target.length === 0) {
                console.warn('crb_validasi: Target form tidak ditemukan untuk dibersihkan.');
                return;
            }

            // 1. Hapus kelas Bootstrap (is-invalid, is-valid) dari semua elemen
            $target.find('.is-invalid, .is-valid').removeClass('is-invalid is-valid');

            // 2. Hapus semua elemen pesan feedback yang mungkin ditambahkan 
            //    oleh jQuery Validation Plugin (errorElement: "span" atau "div")
            //    Asumsi Anda menggunakan class CSS 'invalid-feedback'
            $target.find('.invalid-feedback, .valid-feedback, .error').remove();

            // 3. (Opsional) Hapus internal data dari Validation Plugin jika digunakan
            if ($target.data('validator')) {
                $target.data('validator').resetForm();
            }

            console.log('crb_validasi: Validasi form berhasil dibersihkan.');
        },

        /**
         * Mereset seluruh nilai form ke kondisi awal (kosong).
         * * @param {string|HTMLElement|jQuery} target Selector atau elemen form yang akan direset.
         */
        // resetForm: function (target) {
        //     const $target = $(target);
        //     const form = $target.find('form')[0];
        //     if (form) form.reset();

        //     $target.find('.is-invalid, .is-valid').removeClass('is-invalid is-valid');
        //     $target.find('.invalid-feedback, .valid-feedback').remove();

        //     // const $target = $(target);
        //     // const form = $target.is('form') ? $target[0] : $target.find('form')[0];

        //     // if (form) {
        //     //     form.reset();
        //     // }
        //     // this.Clear(target); // Bersihkan juga visual error setelah reset
        // },

        /**
         * Objek konfigurasi default untuk jQuery Validation Plugin 
         * yang disesuaikan untuk integrasi Bootstrap 4/5 dan CI4.
         */
        Element: {
            ignore: [],
            errorElement: "span",
            errorClass: "invalid-feedback",
            highlight: function (element) {
                $(element).addClass('is-invalid').removeClass('is-valid');
            },
            unhighlight: function (element) {
                $(element).removeClass('is-invalid').addClass('is-valid');
            },
            errorPlacement: function (error, element) {
                // Cari parent .input-group atau .form-group
                const $parent = element.closest('.input-group, .form-group');

                if ($parent.length) {
                    // Masukkan error ke parent container terdekat
                    error.appendTo($parent);
                } else if (element.is('.select') || element.hasClass('select2') || element.hasClass('selectpicker')) {
                    // Penanganan khusus untuk Select2/Selectpicker
                    error.insertAfter(element.next());
                } else {
                    // Default: Masukkan error setelah elemen input
                    error.insertAfter(element);
                }
            },
            // Tambahkan submitHandler: function(form) { /* Your AJAX call here */ } jika perlu
        }
    };

})(jQuery);

// $formServer.validate($.extend(true, {}, $.crb_validasi.validationDefaults, {
//     // Di sini Anda hanya perlu mendefinisikan rules dan messages spesifik
//     rules: {
//         server_nama: { required: true, minlength: 3, maxlength: 50 },
//         server_lokasi: { required: false, maxlength: 100 },
//     },
//     // Jika Anda ingin menimpa fungsi errorPlacement, definisikan di sini
//     // messages: { ... }
// }));
// **Catatan penting:** Gunakan `$.extend(true, {}, ...)` untuk menggabungkan objek secara mendalam dan aman, memastikan `validationDefaults` tidak tertimpa dan *rules* Anda ditambahkan dengan benar.

// ## manual ##
// $formServer.validate({
//     ignore: [],
//     errorElement: "span",
//     errorClass: "invalid-feedback",
//     highlight: function (element) {
//         $(element).addClass('is-invalid').removeClass('is-valid');
//     },
//     unhighlight: function (element) {
//         $(element).removeClass('is-invalid').addClass('is-valid');
//     },
//     errorPlacement: function (error, element) {
//         const $parent = element.closest('.input-group, .form-group');
//         if ($parent.length) {
//             error.appendTo($parent);
//         } else if (element.is('.select') || element.hasClass('select2') || element.hasClass('selectpicker')) {
//             error.insertAfter(element.next());
//         } else {
//             error.insertAfter(element);
//         }
//     },
//     rules: {
//         server_nama: { required: true, minlength: 3, maxlength: 50 },
//         server_lokasi: { required: false, maxlength: 100 },
//         server_ip: { required: false, ipv4: true }
//     }
// });