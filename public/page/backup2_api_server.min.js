/*!
 * CirebonWeb (https://cirebonweb.com)
 * Copyright (c) 2023 CirebonWeb
 * Licensed under MIT (https://opensource.org/licenses/MIT)
 */

/**
 * api_server.js
 * Script jQuery untuk menangani interaksi form server,
 * termasuk navigasi stepper, tes koneksi, dan simpan/update data.
 * MENGGUNAKAN jQuery AJAX untuk komunikasi API.
 */

// Menghapus ketergantungan FetchHelper.

// Ini adalah bagian dari implementasi CSRF lama (Hanya untuk referensi/jika ada refreshCsrf)
// if (typeof window.Beranda === 'undefined') {
//     window.Beranda = {};
// }


$(function () {
    // Inisialisasi BS-Stepper
    const stepperElement = document.querySelector('#stepper');
    if (stepperElement) {
        window.stepper = new Stepper(stepperElement, {
            linear: true, 
            animation: true
        });
    }

    // --- Variabel dan Konfigurasi ---
    const $serverForm = $('#serverForm');
    const $btnServerTes = $('#btnServerTes');
    const $testStatus = $('#testStatus');
    const $server_id = $('#server_id');

    // Asumsi BASE_URL tersedia 
    const BASE_URL = Beranda?.BASE_URL || ''; 


    // Fungsi untuk menampilkan pesan error (Digunakan untuk validasi lokal non-API)
    const showError = (title, text) => {
        Swal.fire({
            icon: 'error',
            title: title || 'Terjadi Kesalahan!',
            html: text || 'Silakan coba lagi atau hubungi administrator.',
        });
    };
    
    // Fungsi untuk memformat angka menjadi format ribuan
    const formatRupiah = (angka) => {
        let number_string = angka.replace(/[^,\d]/g, '').toString(),
            split = number_string.split(','),
            sisa = split[0].length % 3,
            rupiah = split[0].substr(0, sisa),
            ribuan = split[0].substr(sisa).match(/\d{3}/gi);

        if (ribuan) {
            let separator = sisa ? '.' : '';
            rupiah = rupiah + separator + ribuan.join('.');
        }

        rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
        return rupiah;
    };

    // Fungsi untuk mendapatkan data form dalam bentuk objek
    const getFormData = ($form) => {
        const unindexed_array = $form.serializeArray();
        const indexed_array = {};

        $.map(unindexed_array, function (n, i) {
            if (n.name === 'sewa_biaya') {
                indexed_array[n.name] = n.value.replace(/\./g, '').replace(',', '.');
            } else {
                indexed_array[n.name] = n.value;
            }
        });
        return indexed_array;
    };

    // --- Validasi Form Stepper Navigation ---

    $('.btn-next-form').on('click', function () {
        const currentStepContentId = $(this).closest('.content').attr('id');
        const $currentStepInputs = $(`#${currentStepContentId} :input[required]`);
        let isValid = true;

        $currentStepInputs.each(function () {
            if (!$serverForm.validate().element(this)) {
                isValid = false;
            }
        });

        if (isValid) {
            window.stepper.next();
        } else {
            $serverForm.find('.error:first').focus();
        }
    });

    $('.btn-prev-form').on('click', function () {
        window.stepper.previous();
    });
    
    // Fungsi umum untuk menangani kegagalan AJAX (Network/500 Internal Error)
    const handleAjaxFailure = (jqXHR) => {
        let errorMessage = 'Kesalahan saat menerima respons dari server.';
        
        if (jqXHR.responseJSON && jqXHR.responseJSON.messages) {
            // Jika server mengembalikan JSON error yang bersih
            errorMessage = jqXHR.responseJSON.messages;
        } else if (jqXHR.responseText && jqXHR.status === 500) {
            // Kemungkinan Filter CI4 (bukan hanya CSRF) merusak input stream JSON.
            errorMessage = `Kesalahan Server Internal (Status ${jqXHR.status}). Kemungkinan Filter Keamanan CI4 mengganggu stream input JSON, menyebabkan data gagal terbaca di server.`;
        } else if (jqXHR.status !== 0) {
            errorMessage = `Kegagalan Komunikasi (Status: ${jqXHR.status}).`;
        }
        
        Swal.fire('Error', errorMessage.substring(0, 500) + (errorMessage.length > 500 ? '...' : ''), 'error');
    };

    // --- 1. Tes Koneksi Server (id="btnServerTes") ---
    $btnServerTes.on('click', function (e) {
        e.preventDefault();
        
        const $step2RequiredInputs = $('#step2 :input[required]');
        let isValid = true;
        
        $step2RequiredInputs.each(function () {
            if (!$serverForm.validate().element(this)) {
                isValid = false;
            }
        });

        if (!isValid) {
            $serverForm.find('.error:first').focus();
            return;
        }
        
        const data = {
            con_host: $('#con_host').val(),
            con_user: $('#con_user').val(),
            con_token: $('#con_token').val(),
            con_port: $('#con_port').val(),
        };

        const $this = $(this);
        $this.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Mengetes...');
        $testStatus.html('<span class="text-info">Menunggu respon server...</span>');

        // PENGGUNAAN JQUERY AJAX
        $.ajax({
            url: 'server/tesapi', // Relatif ke URL saat ini
            method: 'POST',
            contentType: 'application/json', // Penting: Kirim sebagai JSON
            dataType: 'json', // Harapkan respons sebagai JSON
            data: JSON.stringify(data)
        })
        .done(function(result) {
            // Response berhasil diterima dan di-parse sebagai JSON
            if (result && result.success) {
                // Sukses Logic
                Swal.fire('Berhasil', result.messages || 'Koneksi berhasil dilakukan.', 'success');
                $testStatus.html('<span class="text-success font-weight-bold">✅ Koneksi Berhasil!</span>');
                
                // Mengambil value dari respons dan mengisinya ke form
                if (result.data) {
                    $('#server_os').val(result.data.server_os || '');
                    $('#cpanel_versi').val(result.data.cpanel_versi || '');
                    $('#akun_aktif').val(result.data.akun_aktif || 0);
                }
            } else {
                // API merespons dengan JSON, tetapi menandai kegagalan (success: false)
                const displayMessage = result?.messages || 'Kegagalan server terdeteksi. Silakan cek log CI4.';
                Swal.fire('Error', displayMessage, 'error');
                $testStatus.html('<span class="text-danger font-weight-bold">❌ Koneksi Gagal!</span>');
            }
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
            // Network error, JSON parse failure, atau HTTP 4xx/5xx status
            handleAjaxFailure(jqXHR);
            $testStatus.html('<span class="text-danger font-weight-bold">❌ Koneksi Gagal!</span>');
        })
        .always(function() {
            // Reset tombol dan status, terlepas dari sukses/gagal
            $this.prop('disabled', false).html('Tes Koneksi');
        });
    });

    // --- 2. Submit Form (Simpan/Update) ---
    $serverForm.on('submit', function (e) {
        e.preventDefault();

        if (!$serverForm.valid()) {
            showError('Validasi Gagal', 'Harap lengkapi semua field yang wajib diisi.');
            window.stepper.to(1);
            $serverForm.find('.error:first').focus();
            return;
        }

        const formData = getFormData($(this));
        const serverId = $server_id.val();
        
        const isUpdate = serverId && serverId !== '0';
        const url = BASE_URL + (isUpdate ? `api/server/update/${serverId}` : 'api/server/save'); 

        const $submitButton = $(this).find('button[type="submit"]');
        const originalText = isUpdate ? 'Update' : 'Simpan';
        
        $submitButton.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memproses...');

        // PENGGUNAAN JQUERY AJAX
        $.ajax({
            url: url,
            method: 'POST',
            contentType: 'application/json', // Penting: Kirim sebagai JSON
            dataType: 'json', // Harapkan respons sebagai JSON
            data: JSON.stringify(formData)
        })
        .done(function(result) {
            // Response berhasil diterima dan di-parse sebagai JSON
            if (result && result.success) {
                // Sukses Logic
                Swal.fire('Berhasil', result.messages || 'Aksi berhasil dilakukan.', 'success');
                
                // Opsional: Redirect atau reset form setelah simpan/update
                // window.location.href = BASE_URL + 'server';
            } else {
                // API merespons dengan JSON, tetapi menandai kegagalan (success: false)
                const displayMessage = result?.messages || 'Kegagalan server terdeteksi.';
                Swal.fire('Error', displayMessage, 'error');
            }
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
            // Network error, JSON parse failure, atau HTTP 4xx/5xx status
            handleAjaxFailure(jqXHR);
        })
        .always(function() {
            $submitButton.prop('disabled', false).html(originalText);
        });
    });
    
    // --- Konfigurasi jQuery Validation Plugin ---
    $serverForm.validate({
        ignore: [],
        errorElement: 'span',
        errorClass: 'invalid-feedback',
        highlight: function (element) {
            $(element).addClass('is-invalid').removeClass('is-valid');
        },
        unhighlight: function (element) {
            $(element).removeClass('is-invalid').addClass('is-valid');
        },
        errorPlacement: function (error, element) {
            const $parent = element.closest('.input-group, .form-group');
            if ($parent.length) {
                $parent.append(error);
            } else if (element.is('.select') || element.hasClass('select2') || element.hasClass('selectpicker')) {
                error.insertAfter(element.next());
            } else {
                error.insertAfter(element);
            }
        },        
        rules: {
            server_nama: { required: true, minlength: 3, maxlength: 50 },
            server_lokasi: { required: false, maxlength: 100 },
            server_ip: { required: false, ipv4: true },
            server_url: { required: false, url: true, maxlength: 255 },
            sewa_biaya: { required: false, number: true, min: 0 },
            sewa_awal: { required: false, dateISO: true },
            sewa_akhir: { required: false, dateISO: true },
            akun_limit: { required: false, digits: true, min: 0 },
            akun_aktif: { required: false, digits: true, min: 0 },
            aktivasi: { required: true, digits: true, range: [0, 1] },
            con_host: { required: true, maxlength: 100 },
            con_user: { required: true, maxlength: 50 },
            con_token: { required: true, minlength: 20, maxlength: 255 },
            con_port: { required: true, digits: true, range: [1, 65535] },
            server_os: { required: false, maxlength: 40 },
            cpanel_versi: { required: false, maxlength: 15 },
            ns1: { required: false, maxlength: 100 },
            ns2: { required: false, maxlength: 100 },
            ns3: { required: false, maxlength: 100 },
            ns4: { required: false, maxlength: 100 },
            ip1: { required: false, ipv4: true },
            ip2: { required: false, ipv4: true },
            ip3: { required: false, ipv4: true },
            ip4: { required: false, ipv4: true }
        },
        messages: {
            // ditangani oleh jQuery Validation Plugin - v1.19.5
        }
    });

    // --- Inisialisasi Datepicker ---
    if ($.fn.datepicker) {
        $('.date').datepicker({
            dateFormat: 'yy-mm-dd'
        });
    }

    // Logika format angka untuk sewa_biaya
    $('#sewa_biaya').on('keyup', function() {
        $(this).val(formatRupiah($(this).val()));
    });

    // --- Event Listener untuk Case Input (Capital) ---
    $('input.capital').on('input', function () {
        const input = $(this).val();
        if (input.length > 0) {
            const capitalized = input.charAt(0).toUpperCase() + input.slice(1);
            $(this).val(capitalized);
        }
    });
});
