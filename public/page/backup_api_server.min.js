/*!
 * CirebonWeb (https://cirebonweb.com)
 * Copyright (c) 2023 CirebonWeb
 * Licensed under MIT (https://opensource.org/licenses/MIT)
 */

$(function () {
    const stepperElement = document.querySelector('#stepper');
    const stepper = new Stepper(stepperElement, {
        animation: true
    });

    const $form = $('#serverForm');
    const validator = $form.validate({
        ignore: [],
        errorElement: 'span',
        errorClass: 'invalid-feedback',
        highlight: function (element) {
            $(element).addClass('is-invalid').removeClass('is-valid');
        },
        unhighlight: function (element) {
            $(element).removeClass('is-invalid').addClass('is-valid');
        },
        errorPlacement: function (error, element) {
            const $parent = element.closest('.input-group, .form-group');
            if ($parent.length) {
                $parent.append(error);
            } else if (element.is('.select') || element.hasClass('select2') || element.hasClass('selectpicker')) {
                error.insertAfter(element.next());
            } else {
                error.insertAfter(element);
            }
        },
        rules: {
            server_nama: { required: true, minlength: 3, maxlength: 50 },
            server_lokasi: { required: false, maxlength: 100 },
            server_ip: { required: false, ipv4: true },
            server_url: { required: false, url: true, maxlength: 255 },
            sewa_biaya: { required: false, number: true, min: 0 },
            sewa_awal: { required: false, dateISO: true },
            sewa_akhir: { required: false, dateISO: true },
            akun_limit: { required: false, digits: true, min: 0 },
            akun_aktif: { required: false, digits: true, min: 0 },
            aktivasi: { required: true, digits: true, range: [0, 1] },
            con_host: { required: true, maxlength: 100 },
            con_user: { required: true, maxlength: 50 },
            con_token: { required: true, minlength: 20, maxlength: 255 },
            con_port: { required: true, digits: true, range: [1, 65535] },
            server_os: { required: false, maxlength: 40 },
            cpanel_versi: { required: false, maxlength: 15 },
            ns1: { required: false, maxlength: 100 },
            ns2: { required: false, maxlength: 100 },
            ns3: { required: false, maxlength: 100 },
            ns4: { required: false, maxlength: 100 },
            ip1: { required: false, ipv4: true },
            ip2: { required: false, ipv4: true },
            ip3: { required: false, ipv4: true },
            ip4: { required: false, ipv4: true }
        },
        submitHandler: (form) => {
            // Handle form submission
        }
    });

    $.validator.addMethod("ipv4", function (value, element) {
        return this.optional(element) ||
            /^(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)$/.test(value);
    }, "Masukkan alamat IP valid");

    $('.btn-next-form').on('click', function () {
        const currentPane = $(this).closest('.content');
        const inputs = currentPane.find(':input');

        let valid = true;
        inputs.each(function () {
            if (!validator.element(this)) {
                valid = false;
            }
        });

        if (valid) {
            stepper.next();
        }
    });

    $('.btn-prev-form').on('click', function () {
        stepper.previous();
    });
});

$(document).ready(function () {
    $('#btnServerTes').on('click', function (e) {
        e.preventDefault();
        const btnTes = $(this);
        const btnHtml = btnTes.html();
        let $tesStatus = $('#testStatus');

        $tesStatus.removeClass('ml-2 font-weight-bold').text('');

        const validator = $('#serverForm').validate({
            rules: {
                con_host: { required: true, maxlength: 100 },
                con_user: { required: true, maxlength: 50 },
                con_token: { required: true, minlength: 20, maxlength: 255 },
                con_port: { required: true, digits: true, range: [1, 65535] },
            },
        });

        if ($('#serverForm').valid()) {
            const formData = new FormData();
            formData.append('con_host', $('#con_host').val());
            formData.append('con_user', $('#con_user').val());
            formData.append('con_token', $('#con_token').val());
            formData.append('con_port', $('#con_port').val());

            btnTes.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...');
            btnTes.prop('disabled', true);
            

            $.ajax({
                url: 'server/tesapi',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $tesStatus.addClass('text-success').text('Koneksi OK');
                        $('#akun_aktif').val(response.data.akun_aktif);
                        $('#cpanel_versi').val(response.data.cpanel_versi);
                        $('#server_ip').val(response.data.server_ip);

                        Swal.fire('Berhasil', response.message || 'Koneksi berhasil!', 'success');
                    } else {
                        const msg = response.message || 'Terjadi kesalahan pada koneksi.';
                        Swal.fire('Gagal', msg, 'error');
                    }
                },
                error: function (xhr) {
                    const msg =
                        xhr.responseJSON?.message ||
                        xhr.responseText || 'Terjadi kesalahan saat memproses permintaan.';
                    Swal.fire('Gagal', msg, 'error');
                    $tesStatus.addClass('text-danger').text('Koneksi Gagal!');
                },
                complete: function () {
                    btnTes.prop('disabled', false).html(btnHtml);
                    Beranda.refreshCsrf();
                }
            });
        }
    });
});